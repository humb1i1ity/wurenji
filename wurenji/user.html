<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ç”¨æˆ·ä¸­å¿ƒ - æ— äººæœºå¤–å–å¹³å°</title>
        <link rel="stylesheet" href="styles.css">
        <!-- å¼•å…¥Leafletåœ°å›¾åº“ -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    </head>
<body>
    <div class="container">
        <header>
            <h1>ç”¨æˆ·ä¸­å¿ƒ</h1>
            <div class="user-info">
                <div class="user-profile">
                    <span id="username"></span>
                    <button id="logout">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </header>
        
        <!-- å–é¤æ–¹å¼åˆ‡æ¢ -->
        <div class="pickup-type">
            <button class="pickup-btn active" data-type="window">çª—å£å–é¤</button>
            <button class="pickup-btn" data-type="delivery">é…é€ä¸Šé—¨</button>
        </div>
        
        <!-- èœå“åˆ†ç±»ç­›é€‰ -->
        <div class="category-filter">
            <button class="category-btn active" data-category="all">å…¨éƒ¨</button>
            <button class="category-btn" data-category="å·èœ">å·èœ</button>
            <button class="category-btn" data-category="é¢é£Ÿ">é¢é£Ÿ</button>
            <button class="category-btn" data-category="å®¶å¸¸èœ">å®¶å¸¸èœ</button>
        </div>
        
        <nav>
            <ul>
                <li><a href="#products" class="nav-link active">å•†å“åˆ—è¡¨</a></li>
                <li><a href="#orders" class="nav-link">æˆ‘çš„è®¢å•</a></li>
                <li><a href="#profile" class="nav-link">ä¸ªäººä¿¡æ¯</a></li>
            </ul>
        </nav>
        
        <main>
            <!-- å•†å“åˆ—è¡¨ -->
            <section id="products" class="content-section active">
                <h2>å•†å“åˆ—è¡¨</h2>
                <div class="product-list" id="productList">
                    <!-- å•†å“å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
                <!-- ç©ºæ•°æ®æç¤º -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">ğŸœ</div>
                    <p>æš‚æ— èœå“ï¼Œè¯·ç¨åå†è¯•</p>
                </div>
                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading-state" id="loadingState" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½èœå“...</p>
                </div>
            </section>
            
            <!-- æˆ‘çš„è®¢å• -->
            <section id="orders" class="content-section">
                <h2>æˆ‘çš„è®¢å•</h2>
                <div class="order-list" id="orderList">
                    <!-- è®¢å•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </section>
            
            <!-- ä¸ªäººä¿¡æ¯ -->
            <section id="profile" class="content-section">
                <h2>ä¸ªäººä¿¡æ¯</h2>
                <div class="profile-info" id="profileInfo">
                    <!-- ä¸ªäººä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        const user = JSON.parse(localStorage.getItem('user'));
        const offlineMode = localStorage.getItem('offlineMode') === 'true';
        
        if (!user || user.role !== 'user') {
            window.location.href = 'index.html';
        }
        
        // æ˜¾ç¤ºç”¨æˆ·å
        document.getElementById('username').textContent = user.name;
        
        // é€€å‡ºç™»å½•
        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('user');
            localStorage.removeItem('offlineMode');
            window.location.href = 'index.html';
        });
        
        // ç¦»çº¿æ•°æ®æ¨¡æ‹Ÿ
        const mockData = {
            products: [
                { id: 'PR001', merchantId: 'ME001', name: 'å®«ä¿é¸¡ä¸', description: 'ä¼ ç»Ÿå·èœï¼Œé¸¡è‚‰é²œå«©ï¼ŒèŠ±ç”Ÿé¦™è„†', price: 28.00, image: '', status: 'active' },
                { id: 'PR002', merchantId: 'ME001', name: 'é±¼é¦™è‚‰ä¸', description: 'ç»å…¸å·èœï¼Œé…¸ç”œå¯å£ï¼Œé¦™æ°”å››æº¢', price: 25.00, image: '', status: 'active' },
                { id: 'PR003', merchantId: 'ME001', name: 'éº»å©†è±†è…', description: 'éº»è¾£é²œé¦™ï¼Œè±†è…å«©æ»‘', price: 20.00, image: '', status: 'active' },
                { id: 'PR004', merchantId: 'ME001', name: 'ç³–é†‹æ’éª¨', description: 'å¤–é…¥é‡Œå«©ï¼Œé…¸ç”œå¼€èƒƒ', price: 35.00, image: '', status: 'active' },
                { id: 'PR005', merchantId: 'ME001', name: 'è¥¿çº¢æŸ¿é¸¡è›‹é¢', description: 'å®¶å¸¸é¢é£Ÿï¼Œè¥å…»ä¸°å¯Œ', price: 18.00, image: '', status: 'active' }
            ],
            orders: [
                {
                    id: 'OR001',
                    userId: 'US001',
                    merchantId: 'ME001',
                    totalPrice: 53.00,
                    status: 'delivering',
                    deliveryAddress: 'åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯1å·',
                    deliveryPosition: { lat: 39.9088, lng: 116.4044 },
                    paymentMethod: 'online',
                    paymentStatus: 'completed',
                    estimatedDeliveryTime: Date.now() + 300000,
                    actualDeliveryTime: null,
                    mealStatus: 'completed',
                    mealReadyTime: Date.now(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ],
            drones: [
                {
                    id: 'DR001',
                    name: 'é…é€æ— äººæœº1å·',
                    status: 'delivering',
                    position: { lat: 39.9288, lng: 116.3944 },
                    battery: 85,
                    capacity: 10
                }
            ],
            deliveries: [
                {
                    id: 'DE001',
                    orderId: 'OR001',
                    droneId: 'DR001',
                    status: 'delivering',
                    pickupPosition: { lat: 39.9834, lng: 116.3159 },
                    dropoffPosition: { lat: 39.9088, lng: 116.4044 },
                    route: [
                        { lat: 39.9834, lng: 116.3159 },
                        { lat: 39.9534, lng: 116.3659 },
                        { lat: 39.9288, lng: 116.3944 },
                        { lat: 39.9088, lng: 116.4044 }
                    ],
                    currentPosition: { lat: 39.9288, lng: 116.3944 },
                    estimatedTime: 300,
                    actualTime: null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ]
        };
        
        // æ¨¡æ‹ŸWebSocket
        const mockSocket = {
            on: function(event, callback) {
                if (event === 'light-data') {
                    // æ¨¡æ‹Ÿå…‰æ•æ•°æ®æ›´æ–°
                    setInterval(() => {
                        callback({ light: Math.floor(Math.random() * 100), threshold: 50 });
                    }, 2000);
                } else if (event === 'drone-approaching') {
                    // æ¨¡æ‹Ÿæ— äººæœºæ¥è¿‘
                    setTimeout(() => {
                        callback({ droneName: 'é…é€æ— äººæœº1å·', distance: 0.001 });
                    }, 5000);
                } else if (event === 'drone-arrived') {
                    // æ¨¡æ‹Ÿæ— äººæœºåˆ°è¾¾
                    setTimeout(() => {
                        callback({ droneName: 'é…é€æ— äººæœº1å·' });
                    }, 10000);
                }
            }
        };
        
        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                
                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                this.classList.add('active');
                const targetId = this.getAttribute('href').substring(1);
                document.getElementById(targetId).classList.add('active');
                
                // åŠ è½½å¯¹åº”å†…å®¹
                if (targetId === 'products') {
                    loadProducts();
                } else if (targetId === 'orders') {
                    loadOrders();
                } else if (targetId === 'profile') {
                    loadProfile();
                }
            });
        });
        
        // å•†å“åˆ†ç±»æ•°æ®æ˜ å°„
        const productCategoryMap = {
            'PR001': 'å·èœ',
            'PR002': 'å·èœ',
            'PR003': 'å·èœ',
            'PR004': 'å®¶å¸¸èœ',
            'PR005': 'é¢é£Ÿ'
        };
        
        // å½“å‰ç­›é€‰æ¡ä»¶
        let currentFilter = {
            category: 'all',
            pickupType: 'window'
        };
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('productList').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('productList').style.display = 'grid';
        }
        
        // æ˜¾ç¤ºç©ºæ•°æ®çŠ¶æ€
        function showEmptyState() {
            document.getElementById('productList').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
        }
        
        // åŠ è½½å•†å“åˆ—è¡¨
        function loadProducts() {
            showLoading();
            
            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
            setTimeout(() => {
                if (offlineMode) {
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    let products = mockData.products;
                    
                    // åº”ç”¨ç­›é€‰æ¡ä»¶
                    if (currentFilter.category !== 'all') {
                        products = products.filter(product => 
                            productCategoryMap[product.id] === currentFilter.category
                        );
                    }
                    
                    const productList = document.getElementById('productList');
                    productList.innerHTML = '';
                    
                    if (products.length === 0) {
                        hideLoading();
                        showEmptyState();
                        return;
                    }
                    
                    products.forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.className = 'product-item';
                        productItem.innerHTML = `
                            <div class="product-image">ğŸœ</div>
                            <div class="product-info">
                                <h3>${product.name}</h3>
                                <p>${product.description}</p>
                                <div class="product-price">Â¥${product.price.toFixed(2)}</div>
                                <button class="order-btn" data-product-id="${product.id}">ç«‹å³ä¸‹å•</button>
                            </div>
                        `;
                        productList.appendChild(productItem);
                    });
                    
                    // æ·»åŠ ä¸‹å•æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.order-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const productId = this.getAttribute('data-product-id');
                            // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥åˆ›å»ºè®¢å•
                            createOrder(productId);
                        });
                    });
                } else {
                    // æ­£å¸¸åŠ è½½å•†å“
                    fetch('/api/products')
                        .then(response => response.json())
                        .then(products => {
                            // åº”ç”¨ç­›é€‰æ¡ä»¶
                            if (currentFilter.category !== 'all') {
                                products = products.filter(product => 
                                    productCategoryMap[product.id] === currentFilter.category
                                );
                            }
                            
                            const productList = document.getElementById('productList');
                            productList.innerHTML = '';
                            
                            if (products.length === 0) {
                                hideLoading();
                                showEmptyState();
                                return;
                            }
                            
                            products.forEach(product => {
                                const productItem = document.createElement('div');
                                productItem.className = 'product-item';
                                productItem.innerHTML = `
                                    <div class="product-image">ğŸœ</div>
                                    <div class="product-info">
                                        <h3>${product.name}</h3>
                                        <p>${product.description}</p>
                                        <div class="product-price">Â¥${product.price.toFixed(2)}</div>
                                        <button class="order-btn" data-product-id="${product.id}">ç«‹å³ä¸‹å•</button>
                                    </div>
                                `;
                                productList.appendChild(productItem);
                            });
                            
                            // æ·»åŠ ä¸‹å•æŒ‰é’®äº‹ä»¶
                            document.querySelectorAll('.order-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const productId = this.getAttribute('data-product-id');
                                    // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥åˆ›å»ºè®¢å•
                                    createOrder(productId);
                                });
                            });
                        })
                        .catch(error => {
                            console.error('åŠ è½½å•†å“å¤±è´¥ï¼š', error);
                            alert('åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                        });
                }
                
                hideLoading();
            }, 500); // æ¨¡æ‹Ÿ500msåŠ è½½æ—¶é—´
        }
        
        // å–é¤æ–¹å¼åˆ‡æ¢
        document.querySelectorAll('.pickup-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.pickup-btn').forEach(b => b.classList.remove('active'));
                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                this.classList.add('active');
                // æ›´æ–°ç­›é€‰æ¡ä»¶
                currentFilter.pickupType = this.getAttribute('data-type');
                // é‡æ–°åŠ è½½å•†å“
                loadProducts();
            });
        });
        
        // èœå“åˆ†ç±»ç­›é€‰
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                this.classList.add('active');
                // æ›´æ–°ç­›é€‰æ¡ä»¶
                currentFilter.category = this.getAttribute('data-category');
                // é‡æ–°åŠ è½½å•†å“
                loadProducts();
            });
        });
        
        // åˆ›å»ºè®¢å•
        function createOrder(productId) {
            if (offlineMode) {
                // æ¨¡æ‹Ÿåˆ›å»ºè®¢å•
                alert('è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·ï¼šOR' + Math.floor(Math.random() * 1000).toString().padStart(3, '0'));
                loadOrders();
            } else {
                // æ­£å¸¸åˆ›å»ºè®¢å•
                fetch(`/api/products/${productId}`)
                    .then(response => response.json())
                    .then(product => {
                        const order = {
                            merchantId: product.merchantId,
                            items: [{
                                productId: product.id,
                                quantity: 1,
                                price: product.price
                            }],
                            totalPrice: product.price,
                            deliveryAddress: user.address,
                            deliveryPosition: user.position,
                            paymentMethod: 'online'
                        };
                        
                        return fetch('/api/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'user-id': user.id
                            },
                            body: JSON.stringify(order)
                        });
                    })
                    .then(response => response.json())
                    .then(result => {
                        alert('è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·ï¼š' + result.id);
                        loadOrders();
                    })
                    .catch(error => {
                        console.error('åˆ›å»ºè®¢å•å¤±è´¥ï¼š', error);
                        alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    });
            }
        }
        
        // åŠ è½½è®¢å•åˆ—è¡¨
        function loadOrders() {
            if (offlineMode) {
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const orders = mockData.orders;
                const orderList = document.getElementById('orderList');
                orderList.innerHTML = '';
                
                orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <div class="order-header">
                            <span class="order-id">è®¢å•å·ï¼š${order.id}</span>
                            <span class="order-status">çŠ¶æ€ï¼š${getStatusText(order.status)}</span>
                            <span class="order-time">æ—¶é—´ï¼š${new Date(order.createdAt).toLocaleString()}</span>
                        </div>
                        <div class="order-info">
                            <p>æ€»é‡‘é¢ï¼šÂ¥${order.totalPrice.toFixed(2)}</p>
                            <p>é…é€åœ°å€ï¼š${order.deliveryAddress}</p>
                            <p>å‡ºé¤çŠ¶æ€ï¼š${getMealStatusText(order.mealStatus)}</p>
                        </div>
                        <button class="order-detail-btn" data-order-id="${order.id}">æŸ¥çœ‹è¯¦æƒ…</button>
                    `;
                    orderList.appendChild(orderItem);
                });
                
                // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.order-detail-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-order-id');
                        loadOrderDetail(orderId);
                    });
                });
            } else {
                // æ­£å¸¸åŠ è½½è®¢å•
                fetch('/api/orders', {
                    headers: {
                        'user-id': user.id
                    }
                })
                .then(response => response.json())
                .then(orders => {
                    const orderList = document.getElementById('orderList');
                    orderList.innerHTML = '';
                    
                    orders.forEach(order => {
                        const orderItem = document.createElement('div');
                        orderItem.className = 'order-item';
                        orderItem.innerHTML = `
                            <div class="order-header">
                                <span class="order-id">è®¢å•å·ï¼š${order.id}</span>
                                <span class="order-status">çŠ¶æ€ï¼š${getStatusText(order.status)}</span>
                                <span class="order-time">æ—¶é—´ï¼š${new Date(order.createdAt).toLocaleString()}</span>
                            </div>
                            <div class="order-info">
                                <p>æ€»é‡‘é¢ï¼šÂ¥${order.totalPrice.toFixed(2)}</p>
                                <p>é…é€åœ°å€ï¼š${order.deliveryAddress}</p>
                                <p>å‡ºé¤çŠ¶æ€ï¼š${getMealStatusText(order.mealStatus)}</p>
                            </div>
                            <button class="order-detail-btn" data-order-id="${order.id}">æŸ¥çœ‹è¯¦æƒ…</button>
                        `;
                        orderList.appendChild(orderItem);
                    });
                    
                    // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.order-detail-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-order-id');
                            loadOrderDetail(orderId);
                        });
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢å•å¤±è´¥ï¼š', error);
                    alert('åŠ è½½è®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }
        
        // åŠ è½½è®¢å•è¯¦æƒ…
        function loadOrderDetail(orderId) {
            if (offlineMode) {
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const order = mockData.orders.find(o => o.id === orderId);
                if (order) {
                    alert(JSON.stringify(order, null, 2));
                } else {
                    alert('è®¢å•ä¸å­˜åœ¨');
                }
            } else {
                // æ­£å¸¸åŠ è½½è®¢å•è¯¦æƒ…
                fetch(`/api/orders/${orderId}`, {
                    headers: {
                        'user-id': user.id
                    }
                })
                .then(response => response.json())
                .then(order => {
                    // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºè®¢å•è¯¦æƒ…
                    alert(JSON.stringify(order, null, 2));
                })
                .catch(error => {
                    console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥ï¼š', error);
                    alert('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }
        
        // åŠ è½½ä¸ªäººä¿¡æ¯
        function loadProfile() {
            if (offlineMode) {
                // ä½¿ç”¨æœ¬åœ°ç”¨æˆ·æ•°æ®
                const userInfo = user;
                const profileInfo = document.getElementById('profileInfo');
                profileInfo.innerHTML = `
                    <p><strong>ç”¨æˆ·åï¼š</strong>${userInfo.username}</p>
                    <p><strong>å§“åï¼š</strong>${userInfo.name}</p>
                    <p><strong>ç”µè¯ï¼š</strong>${userInfo.phone}</p>
                    <p><strong>åœ°å€ï¼š</strong>${userInfo.address}</p>
                    <p><strong>è§’è‰²ï¼š</strong>${userInfo.role}</p>
                    <p><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${new Date(userInfo.createdAt).toLocaleString()}</p>
                `;
            } else {
                // æ­£å¸¸åŠ è½½ä¸ªäººä¿¡æ¯
                fetch('/api/user', {
                    headers: {
                        'user-id': user.id
                    }
                })
                .then(response => response.json())
                .then(userInfo => {
                    const profileInfo = document.getElementById('profileInfo');
                    profileInfo.innerHTML = `
                        <p><strong>ç”¨æˆ·åï¼š</strong>${userInfo.username}</p>
                        <p><strong>å§“åï¼š</strong>${userInfo.name}</p>
                        <p><strong>ç”µè¯ï¼š</strong>${userInfo.phone}</p>
                        <p><strong>åœ°å€ï¼š</strong>${userInfo.address}</p>
                        <p><strong>è§’è‰²ï¼š</strong>${userInfo.role}</p>
                        <p><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${new Date(userInfo.createdAt).toLocaleString()}</p>
                    `;
                })
                .catch(error => {
                    console.error('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥ï¼š', error);
                    alert('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }
        
        // çŠ¶æ€æ–‡æœ¬è½¬æ¢
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å¤„ç†',
                'processing': 'å¤„ç†ä¸­',
                'delivering': 'é…é€ä¸­',
                'delivered': 'å·²é€è¾¾',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        // å‡ºé¤çŠ¶æ€æ–‡æœ¬è½¬æ¢
        function getMealStatusText(mealStatus) {
            const mealStatusMap = {
                'not_started': 'æœªå¼€å§‹',
                'in_progress': 'åˆ¶ä½œä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            return mealStatusMap[mealStatus] || mealStatus;
        }
        
        // åˆå§‹åŒ–åŠ è½½å•†å“åˆ—è¡¨
        loadProducts();
        
        // WebSocketè¿æ¥ï¼Œå®æ—¶æ¥æ”¶é…é€ä¿¡æ¯
        const socket = offlineMode ? mockSocket : io();
        
        // æ¶ˆæ¯æç¤ºæ¨¡å—
        const messageModule = {
            showMessage: function(type, message) {
                const messageContainer = document.getElementById('messageContainer');
                if (!messageContainer) {
                    // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                    const container = document.createElement('div');
                    container.id = 'messageContainer';
                    container.className = 'message-container';
                    document.body.appendChild(container);
                }
                
                // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${type}`;
                messageEl.innerHTML = `
                    <div class="message-content">${message}</div>
                    <button class="message-close" onclick="this.parentElement.remove()">&times;</button>
                `;
                
                // æ·»åŠ åˆ°å®¹å™¨
                const container = document.getElementById('messageContainer');
                container.appendChild(messageEl);
                
                // 3ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.remove();
                    }
                }, 3000);
            },
            showSuccess: function(message) {
                this.showMessage('success', message);
            },
            showInfo: function(message) {
                this.showMessage('info', message);
            },
            showWarning: function(message) {
                this.showMessage('warning', message);
            },
            showError: function(message) {
                this.showMessage('error', message);
            }
        };
        
        // æ— äººæœºå®æ—¶ç›‘æµ‹æ¨¡å—
        const droneMonitoring = {
            map: null,
            droneMarker: null,
            destinationMarker: null,
            routePolyline: null,
            
            init: function() {
                this.createMonitoringPanel();
                this.startMonitoring();
            },
            
            createMonitoringPanel: function() {
                const container = document.querySelector('.container');
                const panel = document.createElement('div');
                panel.id = 'droneMonitoringPanel';
                panel.className = 'drone-monitoring-panel';
                panel.innerHTML = `
                    <div class="drone-monitoring-header">
                        <h3>æ— äººæœºå®æ—¶ç›‘æµ‹</h3>
                        <div class="refresh-time">æ•°æ®åˆ·æ–°æ—¶é—´ï¼š<span id="refreshTime"></span></div>
                    </div>
                    <div class="monitoring-content grid-layout">
                        <!-- å½“å‰è®¢å•æ¨¡å— -->
                        <div class="monitoring-module order-info-module">
                            <h4 class="module-title">å½“å‰è®¢å•</h4>
                            <div class="module-content">
                                <div class="order-id-section">
                                    <span class="label">è®¢å•ç¼–å·</span>
                                    <span class="badge-primary" id="currentOrderId">OR001</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">è®¢å•çŠ¶æ€</span>
                                    <span class="status status-delivering" id="orderStatus"></span>
                                </div>
                                <div class="info-row">
                                    <span class="label">å‡ºé¤çŠ¶æ€</span>
                                    <span class="status" id="mealStatus"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ— äººæœºä¿¡æ¯æ¨¡å— -->
                        <div class="monitoring-module drone-info-module">
                            <h4 class="module-title">æ— äººæœºä¿¡æ¯</h4>
                            <div class="module-content">
                                <div class="info-group">
                                    <span class="group-title">åŸºç¡€ä¿¡æ¯</span>
                                    <div class="info-row">
                                        <span class="label">æ— äººæœºID</span>
                                        <span class="value" id="droneId"></span>
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="group-title">ä½ç½®ä¿¡æ¯</span>
                                    <div class="info-row">
                                        <span class="label">å½“å‰ä½ç½®</span>
                                        <span class="value" id="dronePosition"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="label">ç›®æ ‡ä½ç½®</span>
                                        <span class="value" id="destinationPosition"></span>
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="group-title">é…é€è¿›åº¦</span>
                                    <div class="info-row">
                                        <span class="label">å‰©ä½™è·ç¦»</span>
                                        <span class="value" id="remainingDistance"></span> ç±³
                                    </div>
                                    <div class="info-row">
                                        <span class="label">é¢„è®¡åˆ°è¾¾</span>
                                        <span class="value countdown" id="estimatedTime"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å®æ—¶åœ°å›¾æ¨¡å— -->
                        <div class="monitoring-module map-module">
                            <h4 class="module-title">å®æ—¶åœ°å›¾</h4>
                            <div class="module-content">
                                <div id="droneMap" class="map-container"></div>
                            </div>
                        </div>
                        
                        <!-- å®ä½“å¹³å°å…‰æ•ç›‘æµ‹æ¨¡å— -->
                        <div class="monitoring-module light-sensor-module" id="lightSensorModule">
                            <h4 class="module-title">å®ä½“å¹³å°å…‰æ•ç›‘æµ‹</h4>
                            <div class="module-content">
                                <div class="info-row">
                                    <span class="label">å…‰ç…§å¼ºåº¦</span>
                                    <span class="value" id="lightIntensity"></span> lux
                                </div>
                                <div class="info-row">
                                    <span class="label">å¹³å°çŠ¶æ€</span>
                                    <span class="status" id="platformStatus"></span>
                                </div>
                                <div class="info-row">
                                    <span class="label">æ˜¯å¦æœ‰è´§ç‰©</span>
                                    <span class="status" id="hasCargo"></span>
                                </div>
                                <div class="info-row">
                                    <span class="label">æ£€æµ‹çŠ¶æ€</span>
                                    <span class="status status-normal" id="sensorStatus"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // åœ¨mainå…ƒç´ ä¹‹å‰æ’å…¥é¢æ¿
                const main = document.querySelector('main');
                container.insertBefore(panel, main.nextSibling);
            },
            
            startMonitoring: function() {
                // åˆå§‹åŒ–åœ°å›¾
                this.initMap();
                // åŠ è½½åˆå§‹æ•°æ®
                this.loadOrderData();
                // è®¾ç½®åˆå§‹ä½ç½®
                this.setInitialPositions();
                // æ›´æ–°åˆ·æ–°æ—¶é—´
                this.updateRefreshTime();
                // æ¯ç§’æ›´æ–°ä¸€æ¬¡ä½ç½®
                setInterval(() => {
                    this.updateDronePosition();
                }, 1000);
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡åˆ·æ–°æ—¶é—´
                setInterval(() => {
                    this.updateRefreshTime();
                }, 60000);
            },
            
            updateRefreshTime: function() {
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const refreshTimeElement = document.getElementById('refreshTime');
                if (refreshTimeElement) {
                    refreshTimeElement.textContent = timeString;
                }
            },
            
            initMap: function() {
                // åˆå§‹åŒ–åœ°å›¾å®¹å™¨
                const mapContainer = document.getElementById('droneMap');
                
                // æ·»åŠ åœ°å›¾åŠ è½½çŠ¶æ€
                mapContainer.innerHTML = '<div class="map-loading">æ­£åœ¨åŠ è½½åœ°å›¾...</div>';
                
                // åˆå§‹åŒ–åœ°å›¾
                this.map = L.map('droneMap').setView([39.9088, 116.4044], 13);
                
                // æ·»åŠ OpenStreetMapå›¾å±‚
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map);
                
                // ç§»é™¤é»˜è®¤æ§ä»¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ ·å¼
                this.map.removeControl(this.map.zoomControl);
                
                // æ·»åŠ è‡ªå®šä¹‰ç¼©æ”¾æ§ä»¶
                L.control.zoom({
                    position: 'bottomright',
                    zoomInTitle: 'æ”¾å¤§',
                    zoomOutTitle: 'ç¼©å°'
                }).addTo(this.map);
                
                // åœ°å›¾åŠ è½½å®Œæˆåç§»é™¤åŠ è½½çŠ¶æ€
                this.map.on('load', function() {
                    const loadingElement = mapContainer.querySelector('.map-loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                });
            },
            
            setInitialPositions: function() {
                if (offlineMode) {
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è®¾ç½®åˆå§‹ä½ç½®
                    const drone = mockData.drones[0];
                    const delivery = mockData.deliveries[0];
                    
                    // è‡ªå®šä¹‰æ— äººæœºæ ‡è®°å›¾æ ‡
                    const droneIcon = L.divIcon({
                        className: 'drone-marker',
                        html: '<div class="drone-marker-content">ğŸš</div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    // è‡ªå®šä¹‰ç›®æ ‡ä½ç½®æ ‡è®°å›¾æ ‡
                    const destinationIcon = L.divIcon({
                        className: 'destination-marker',
                        html: '<div class="destination-marker-content">ğŸ“</div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    // æ·»åŠ æ— äººæœºæ ‡è®°
                    this.droneMarker = L.marker([drone.position.lat, drone.position.lng], { icon: droneIcon }).addTo(this.map);
                    this.droneMarker.bindPopup(`<div class="popup-content">æ— äººæœº ${drone.id}<button class="popup-close">&times;</button></div>`).openPopup();
                    
                    // æ·»åŠ ç›®æ ‡ä½ç½®æ ‡è®°
                    this.destinationMarker = L.marker([delivery.dropoffPosition.lat, delivery.dropoffPosition.lng], { icon: destinationIcon }).addTo(this.map);
                    this.destinationMarker.bindPopup('<div class="popup-content">ç›®çš„åœ°<button class="popup-close">&times;</button></div>');
                    
                    // æ·»åŠ è·¯çº¿
                    this.routePolyline = L.polyline(delivery.route, {color: '#165DFF', weight: 3, opacity: 0.7}).addTo(this.map);
                    
                    // è°ƒæ•´åœ°å›¾è§†é‡ä»¥æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°å’Œè·¯çº¿
                    this.map.fitBounds(this.routePolyline.getBounds());
                }
            },
            
            loadOrderData: function() {
                if (offlineMode) {
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    const order = mockData.orders[0];
                    const orderStatusElement = document.getElementById('orderStatus');
                    const mealStatusElement = document.getElementById('mealStatus');
                    
                    // æ›´æ–°è®¢å•çŠ¶æ€
                    const orderStatusText = getStatusText(order.status);
                    orderStatusElement.textContent = orderStatusText;
                    orderStatusElement.className = `status status-${order.status}`;
                    
                    // æ›´æ–°å‡ºé¤çŠ¶æ€
                    const mealStatusText = getMealStatusText(order.mealStatus);
                    mealStatusElement.textContent = mealStatusText;
                    mealStatusElement.className = `status ${order.mealStatus === 'completed' ? 'status-completed' : order.mealStatus === 'in_progress' ? 'status-pending' : 'status-pending'}`;
                    
                    const delivery = mockData.deliveries[0];
                    document.getElementById('droneId').textContent = delivery.droneId;
                    document.getElementById('destinationPosition').textContent = 
                        `${delivery.dropoffPosition.lat.toFixed(4)}, ${delivery.dropoffPosition.lng.toFixed(4)}`;
                    
                    // æ›´æ–°é¢„è®¡åˆ°è¾¾æ—¶é—´ä¸ºå€’è®¡æ—¶
                    this.updateCountdown(delivery.estimatedTime);
                } else {
                    // æ­£å¸¸åŠ è½½æ•°æ®
                    fetch('/api/orders/OR001')
                        .then(response => response.json())
                        .then(order => {
                            const orderStatusElement = document.getElementById('orderStatus');
                            const mealStatusElement = document.getElementById('mealStatus');
                            
                            // æ›´æ–°è®¢å•çŠ¶æ€
                            const orderStatusText = getStatusText(order.status);
                            orderStatusElement.textContent = orderStatusText;
                            orderStatusElement.className = `status status-${order.status}`;
                            
                            // æ›´æ–°å‡ºé¤çŠ¶æ€
                            const mealStatusText = getMealStatusText(order.mealStatus);
                            mealStatusElement.textContent = mealStatusText;
                            mealStatusElement.className = `status ${order.mealStatus === 'completed' ? 'status-completed' : order.mealStatus === 'in_progress' ? 'status-pending' : 'status-pending'}`;
                        })
                        .catch(error => {
                            console.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥ï¼š', error);
                        });
                    
                    fetch('/api/orders/OR001/delivery')
                        .then(response => response.json())
                        .then(deliveries => {
                            if (deliveries.length > 0) {
                                const delivery = deliveries[0];
                                document.getElementById('droneId').textContent = delivery.droneId;
                                document.getElementById('destinationPosition').textContent = 
                                    `${delivery.dropoffPosition.lat.toFixed(4)}, ${delivery.dropoffPosition.lng.toFixed(4)}`;
                                
                                // æ›´æ–°é¢„è®¡åˆ°è¾¾æ—¶é—´ä¸ºå€’è®¡æ—¶
                                this.updateCountdown(delivery.estimatedTime);
                                
                                // æ·»åŠ ç›®æ ‡ä½ç½®æ ‡è®°
                                if (!this.destinationMarker) {
                                    this.destinationMarker = L.marker([delivery.dropoffPosition.lat, delivery.dropoffPosition.lng]).addTo(this.map);
                                    this.destinationMarker.bindPopup('<div class="popup-content">ç›®çš„åœ°<button class="popup-close">&times;</button></div>');
                                }
                                
                                // æ·»åŠ è·¯çº¿
                                if (!this.routePolyline) {
                                    this.routePolyline = L.polyline(delivery.route, {color: '#165DFF'}).addTo(this.map);
                                    // è°ƒæ•´åœ°å›¾è§†é‡ä»¥æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°å’Œè·¯çº¿
                                    this.map.fitBounds(this.routePolyline.getBounds());
                                }
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½é…é€æ•°æ®å¤±è´¥ï¼š', error);
                        });
                }
            },
            
            updateCountdown: function(seconds) {
                const countdownElement = document.getElementById('estimatedTime');
                if (!countdownElement) return;
                
                // æ¸…é™¤ä¹‹å‰çš„å€’è®¡æ—¶
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }
                
                let remainingSeconds = seconds;
                
                const updateDisplay = () => {
                    const minutes = Math.floor(remainingSeconds / 60);
                    const secs = remainingSeconds % 60;
                    countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    
                    if (remainingSeconds <= 0) {
                        clearInterval(this.countdownInterval);
                        countdownElement.textContent = 'å·²åˆ°è¾¾';
                        countdownElement.className = 'status status-completed';
                    }
                    
                    remainingSeconds--;
                };
                
                // åˆå§‹æ›´æ–°
                updateDisplay();
                // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                this.countdownInterval = setInterval(updateDisplay, 1000);
            },
            
            updateDronePosition: function() {
                if (offlineMode) {
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ›´æ–°ä½ç½®
                    const drone = mockData.drones[0];
                    // æ¨¡æ‹Ÿæ— äººæœºå‘ç›®æ ‡ç§»åŠ¨
                    const destination = { lat: 39.9088, lng: 116.4044 };
                    const speed = 0.00001; // æ¯æ¬¡æ›´æ–°ç§»åŠ¨çš„è·ç¦»
                    
                    // è®¡ç®—æ–¹å‘
                    const dx = destination.lat - drone.position.lat;
                    const dy = destination.lng - drone.position.lng;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > speed) {
                        // ç»§ç»­ç§»åŠ¨
                        const ratio = speed / distance;
                        drone.position.lat += dx * ratio;
                        drone.position.lng += dy * ratio;
                    } else {
                        // åˆ°è¾¾ç›®çš„åœ°
                        drone.position = { ...destination };
                    }
                    
                    // æ›´æ–°æ–‡æœ¬æ˜¾ç¤º
                    document.getElementById('dronePosition').textContent = 
                        `${drone.position.lat.toFixed(4)}, ${drone.position.lng.toFixed(4)}`;
                    
                    // è®¡ç®—å‰©ä½™è·ç¦»
                    const remainingDistance = Math.sqrt(
                        Math.pow(drone.position.lat - destination.lat, 2) + 
                        Math.pow(drone.position.lng - destination.lng, 2)
                    ) * 100000; // è½¬æ¢ä¸ºç±³
                    
                    document.getElementById('remainingDistance').textContent = remainingDistance.toFixed(0);
                    
                    // æ›´æ–°åœ°å›¾ä¸Šçš„æ— äººæœºä½ç½®
                    if (this.droneMarker) {
                        this.droneMarker.setLatLng([drone.position.lat, drone.position.lng]);
                    }
                } else {
                    // æ­£å¸¸æ›´æ–°æ— äººæœºä½ç½®
                    fetch('/api/drones/DR001')
                        .then(response => response.json())
                        .then(drone => {
                            // æ›´æ–°æ–‡æœ¬æ˜¾ç¤º
                            document.getElementById('dronePosition').textContent = 
                                `${drone.position.lat.toFixed(4)}, ${drone.position.lng.toFixed(4)}`;
                            
                            // è®¡ç®—å‰©ä½™è·ç¦»
                            const destination = { lat: 39.9088, lng: 116.4044 };
                            const distance = Math.sqrt(
                                Math.pow(drone.position.lat - destination.lat, 2) + 
                                Math.pow(drone.position.lng - destination.lng, 2)
                            ) * 100000; // è½¬æ¢ä¸ºç±³
                            
                            document.getElementById('remainingDistance').textContent = distance.toFixed(0);
                            
                            // æ›´æ–°åœ°å›¾ä¸Šçš„æ— äººæœºä½ç½®
                            if (this.droneMarker) {
                                this.droneMarker.setLatLng([drone.position.lat, drone.position.lng]);
                            } else {
                                // æ·»åŠ æ— äººæœºæ ‡è®°
                                this.droneMarker = L.marker([drone.position.lat, drone.position.lng]).addTo(this.map);
                                this.droneMarker.bindPopup(`æ— äººæœº ${drone.id}`).openPopup();
                            }
                        })
                        .catch(error => {
                            console.error('æ›´æ–°æ— äººæœºä½ç½®å¤±è´¥ï¼š', error);
                        });
                }
            }
        };
        
        // åˆå§‹åŒ–æ— äººæœºå®æ—¶ç›‘æµ‹
        droneMonitoring.init();
        
        // ç›‘å¬é…é€æ›´æ–°
        socket.on('delivery-update', function(update) {
            console.log('é…é€æ›´æ–°ï¼š', update);
            // æ›´æ–°è®¢å•åˆ—è¡¨
            loadOrders();
            
            // æ›´æ–°ç›‘æµ‹é¢æ¿
            droneMonitoring.loadOrderData();
            
            // æ˜¾ç¤ºé…é€æ›´æ–°æ¶ˆæ¯
            messageModule.showInfo(`é…é€æ›´æ–°ï¼šè®¢å• ${update.orderId} çŠ¶æ€å·²æ›´æ–°ä¸º ${update.status}`);
        });
        
        // ç›‘å¬æ— äººæœºæ¥è¿‘æé†’
        socket.on('drone-approaching', function(event) {
            const distance = (event.distance * 100000).toFixed(0);
            messageModule.showWarning(`æ— äººæœº ${event.droneName} æ­£åœ¨æ¥è¿‘æ‚¨çš„ä½ç½®ï¼Œè·ç¦»çº¦ ${distance} ç±³`);
        });
        
        // ç›‘å¬æ— äººæœºåˆ°è¾¾æé†’
        socket.on('drone-arrived', function(event) {
            messageModule.showSuccess(`æ— äººæœº ${event.droneName} å·²åˆ°è¾¾æ‚¨çš„ä½ç½®ï¼Œè¯·å‡†å¤‡å–é¤ï¼`);
        });
        
        // ç›‘å¬å…‰æ•ä¼ æ„Ÿå™¨æ•°æ®
        socket.on('light-data', function(data) {
            const lightIntensity = document.getElementById('lightIntensity');
            const platformStatus = document.getElementById('platformStatus');
            const hasCargo = document.getElementById('hasCargo');
            const sensorStatus = document.getElementById('sensorStatus');
            const lightSensorModule = document.getElementById('lightSensorModule');
            
            if (lightIntensity) {
                lightIntensity.textContent = data.light;
            }
            
            // åˆ¤æ–­å¹³å°çŠ¶æ€å’Œæ˜¯å¦æœ‰è´§ç‰©
            const cargoDetected = data.light < data.threshold;
            const isAbnormal = data.light < 0 || data.light > 1000; // å‡è®¾æ­£å¸¸èŒƒå›´æ˜¯0-1000lux
            
            if (platformStatus) {
                platformStatus.textContent = cargoDetected ? 'å ç”¨' : 'ç©ºé—²';
                platformStatus.className = `status ${cargoDetected ? 'status-pending' : 'status-idle'}`;
            }
            
            if (hasCargo) {
                hasCargo.textContent = cargoDetected ? 'æ˜¯' : 'å¦';
                hasCargo.className = `status ${cargoDetected ? 'status-pending' : 'status-idle'}`;
            }
            
            if (sensorStatus) {
                sensorStatus.textContent = isAbnormal ? 'å¼‚å¸¸' : 'æ­£å¸¸';
                sensorStatus.className = `status ${isAbnormal ? 'status-error' : 'status-normal'}`;
            }
            
            // æ›´æ–°æ¨¡å—çŠ¶æ€
            if (lightSensorModule) {
                if (isAbnormal) {
                    lightSensorModule.className = 'monitoring-module light-sensor-module error';
                    messageModule.showError('å…‰ç…§ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°å¼‚å¸¸å€¼ï¼Œè¯·æ£€æŸ¥è®¾å¤‡ï¼');
                } else if (cargoDetected) {
                    lightSensorModule.className = 'monitoring-module light-sensor-module warning';
                    messageModule.showInfo('å®ä½“å¹³å°æ£€æµ‹åˆ°è´§ç‰©ï¼Œæ— äººæœºå¯èƒ½æ­£åœ¨å¸è´§æˆ–å·²å®Œæˆé…é€ï¼');
                } else {
                    lightSensorModule.className = 'monitoring-module light-sensor-module';
                }
            }
        });
        
        // ç›‘å¬å…‰ç…§è­¦æŠ¥
        socket.on('light-alert', function(alert) {
            messageModule.showWarning(`å…‰ç…§è­¦æŠ¥ï¼šå…‰ç…§å¼ºåº¦ ${alert.light} è¶…è¿‡é˜ˆå€¼ ${alert.threshold}`);
        });
        
        // ç›‘å¬æ— äººæœºåˆ°è¾¾å…‰ä¼ æ„Ÿå™¨èŒƒå›´æé†’
        socket.on('drone-reached-via-light', function(event) {
            messageModule.showSuccess(`æ— äººæœº ${event.droneName} å·²åˆ°è¾¾æ‚¨çš„ä½ç½®ï¼ˆé€šè¿‡å…‰ä¼ æ„Ÿå™¨æ£€æµ‹ï¼‰ï¼Œè¯·å‡†å¤‡å–é¤ï¼`);
        });
    </script>
</body>
</html>